CORE 3.1 — Archiwum / Files Engine
STATUS: STABLE

LAST UPDATE: 2025-12
0. CORE.SYSTEM.MAIL_PIPELINE

1. PIPELINE — детерминированный
   Повторный запуск не ломает состояние.

2. STATELESS
   Нет processed-флагов внутри Python.
   Всё состояние — только файлы и логи.

3. REVIEW — изолирован
   Всё сомнительное идёт туда.
   REVIEW всегда пуст на уровне корня.

4. Чистота важнее автоматизма
   Лучше больше файлов, чем скрытые ошибки.

5. PowerShell — оркестратор
   Python — только логика.

6. Любая логика → сначала в REVIEW
   Потом — повышение уровня автоматизации.

7. Система должна пережить усталость оператора.
==================================================
1. ЦЕЛЬ СИСТЕМЫ
==================================================

Единый, устойчивый архив документов и коммуникаций
(email / pdf / фото / сканы / вложения), который:

- не теряет данные
- не создаёт хаос
- фиксирует источник и хронологию
- раскладывает документы по кейсам
- работает без “угадываний”
- готов к масштабированию

Система предназначена для:
- бизнеса (AlisMeble)
- личных и семейных документов
- авто / финансы / ZUS / контракты

==================================================
2. СРЕДА
==================================================

OS: Windows 11
Python: установлен, PATH настроен
PowerShell: основной инструмент управления
Хранилище: Dropbox

ROOT:
C:\Users\alimg\Dropbox\Archiwum 3.0

==================================================
3. БАЗОВАЯ СТРУКТУРА
==================================================

Archiwum 3.0
│
├─ 00_INBOX
│   ├─ MAIL_RAW
│   │   └─ _STATE
│   └─ _ROUTER_LOGS
│
├─ CASES
│   ├─ _INBOX          ← единая точка входа файлов
│   ├─ _REVIEW         ← сомнительные / ручной разбор
│   │
│   ├─ 01_KLIENTS
│   │   └─ _INBOX
│   │
│   ├─ 02_FIRMA
│   │   └─ _INBOX
│   │
│   └─ 03_CAR
│       └─ _INBOX
│
├─ FLOWS
├─ TYPES
├─ RULES
│
└─ 99_SYSTEM
    ├─ _SCRIPTS
    │   └─ MAIL
    └─ _SECRETS

ПРИНЦИП:
- ничего не кладётся напрямую в кейс
- всё сначала попадает в CASES/_INBOX
- только потом маршрутизируется

==================================================
4. ПОЧТА — ЕДИНЫЙ ХАБ
==================================================

Gmail = центральная шина обработки.

Все источники писем (включая iCloud и почты Юли)
должны попадать в Gmail.

Юридическая принадлежность документов
решается на уровне КЕЙСОВ, а не почтовых ящиков.

==================================================
5. ИСТОЧНИКИ ПОЧТЫ
==================================================

РАЗРЕШЕНО:
- iCloud → Gmail (через переадресацию)
- дополнительные почты → Gmail (через пересылку)

ЗАПРЕЩЕНО:
- использовать iCloud IMAP в боевом пайплайне
- тянуть вложения напрямую из iCloud
- делать автоответы до стабилизации архива

==================================================
6. GMAIL: МЕТКИ И ФИЛЬТРЫ
==================================================

ОБЯЗАТЕЛЬНАЯ МЕТКА:
SOURCE/ICLOUD

ФИЛЬТР (один на один адрес):
- to:(адрес)
- has:attachment

ДЕЙСТВИЯ:
- применить метку SOURCE/ICLOUD
- никогда не отправлять в спам
- НЕ архивировать
- НЕ удалять
- НЕ помечать как прочитанное

==================================================
7. PIPELINE (БОЕВОЙ)
==================================================

-------------------
STEP 1 — IMPORT
-------------------

Источник:
Gmail, письма с меткой SOURCE/ICLOUD и вложениями

Действия:
- сохранить каждое вложение в CASES/_INBOX
- создать meta.json рядом с файлом:
  - from
  - subject
  - date
  - source
  - gmail_id
  - sha1

Учёт:
- state-файл processed_ids (повторов нет)
- CSV-лог в 00_INBOX/_ROUTER_LOGS

-------------------
STEP 2 — ROUTER
-------------------

Источник:
CASES/_INBOX

Действия:
- анализ имени файла + meta.json
- применение RULES/_router_rules.json

Результат:
- уверенно → 01_KLIENTS/_INBOX или 02_FIRMA/_INBOX или 03_CAR/_INBOX
- неуверенно → CASES/_REVIEW

ОГРАНИЧЕНИЯ:
- router НЕ создаёт новые кейсы
- router НЕ угадывает клиента
- router всегда пишет лог

==================================================
8. КЕЙСЫ КЛИЕНТОВ
==================================================

Формат кейса:
C__ИмяКлиента__Город__Год

Пример:
C__Kowalski__Warszawa__2025

Внутри кейса:
- FILES
- CASE.md (описание дела)

==================================================
9. ЧТО УЖЕ СДЕЛАНО
==================================================

- Gmail OAuth работает
- SOURCE/ICLOUD стабилен
- выгрузка вложений работает
- state и логи пишутся
- CASES/_INBOX и _REVIEW функционируют
- ручной и полуавто-разбор возможен

==================================================
10. ЧЕГО НЕ ДЕЛАЕМ
==================================================

- не используем iCloud IMAP
- не делаем автоответы
- не кладём файлы мимо CASES/_INBOX
- не усложняем классификацию без правил

==================================================
11. СЛЕДУЮЩИЕ ШАГИ (ПОСЛЕ СТАБИЛИЗАЦИИ)
==================================================

1. Унификация имён скриптов (1 импортёр, 1 роутер, 1 раннер)
2. Расширение RULES:
   - ZUS
   - KSIEGOWOSC
   - BMW / VECTRA
   - поставщики
3. Полуавтоматическое создание кейсов
4. Только потом — автоответы

==================================================
12. ПРАВИЛО НОВОГО ЧАТА
==================================================

В начале нового чата всегда вставлять:

"Работаем по CORE 3.1.
Шаг: Gmail SOURCE/ICLOUD → CASES/_INBOX → Router."

==================================================
КОНЕЦ CORE
==================================================

---

## КОММЕНТАРИИ ДЛЯ БУДУЩЕГО АССИСТЕНТА (ВАЖНО)

**Это не инструкции пользователю — это инструкции ИИ.**

- Пользователь предпочитает **структуру → фиксацию → детализацию по запросу**
- Не предлагать автоответы, пока явно не попросит
- Не менять архитектуру без прямого запроса
- Любая автоматизация:
  - сначала `_INBOX`
  - потом `_REVIEW`
  - только потом кейсы
- Любая неопределённость → `_REVIEW`, не “угадывать”
- При сомнениях — **спрашивать, а не решать**
- Минимизировать ручные действия (ноут слабый)
- Предпочитать команды PowerShell / Python одной строкой
- Хаос = нарушение CORE → не допускать

---
